<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRChat OSC Controller</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf, #ff006e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        /* Áä∂ÊÄÅÊ†è */
        .status-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            font-size: 0.85rem;
            z-index: 1000;
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ff4444; transition: background 0.3s; }
        .status-dot.connected { background: #00ff88; box-shadow: 0 0 8px #00ff88; }

        /* ‰∏§ÂàóÂ∏ÉÂ±Ä */
        .params-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            .params-section { grid-template-columns: 1fr; }
        }

        /* Èù¢ÊùøÊ†∑Âºè */
        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel h2::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .panel-input h2::before { background: #00d4ff; }
        .panel-input h2 { color: #00d4ff; }

        .panel-output h2::before { background: #00ff88; }
        .panel-output h2 { color: #00ff88; }

        /* ÂèÇÊï∞ÁΩëÊ†º */
        .param-grid {
            display: grid;
            gap: 10px;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* ÂèÇÊï∞È°πÊ†∑Âºè */
        .param-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .param-item:hover { background: rgba(0, 0, 0, 0.3); }

        .param-name {
            font-weight: 500;
            min-width: 140px;
            font-size: 0.85rem;
            word-break: break-all;
        }

        .param-type {
            font-size: 0.65rem;
            color: #888;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            min-width: 35px;
            text-align: center;
        }

        /* ÊªëÂùóÂÆπÂô® */
        .slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
            border-radius: 50%;
            cursor: pointer;
        }

        .value-display {
            min-width: 45px;
            text-align: right;
            font-family: monospace;
            font-size: 0.8rem;
            color: #00d4ff;
        }

        .switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-switch {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            transition: 0.3s;
            border-radius: 24px;
        }

        .slider-switch::before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider-switch {
            background: linear-gradient(135deg, #00d4ff, #7b2cbf);
        }

        input:checked + .slider-switch::before {
            transform: translateX(20px);
        }

        /* Output ÊòæÁ§∫Ê†∑Âºè */
        .output-value {
            min-width: 60px;
            text-align: right;
            font-family: monospace;
            font-size: 0.8rem;
            color: #00ff88;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff, #00ff88);
            border-radius: 3px;
            transition: width 0.1s ease-out;
        }

        .bool-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #444;
            transition: background 0.2s;
        }

        .bool-indicator.active {
            background: #00ff88;
            box-shadow: 0 0 8px #00ff88;
        }

        /* ÊªöÂä®Êù° */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

        /* ÂàÜÁ±ªÊ†áÁ≠æ */
        .param-category {
            font-size: 0.65rem;
            color: #666;
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <div class="status-bar">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">ËøûÊé•‰∏≠...</span>
    </div>

    <div class="container">
        <h1>VRChat OSC Controller</h1>

        <div class="params-section">
            <!-- Input ÂèÇÊï∞Èù¢Êùø -->
            <div class="panel panel-input">
                <h2>üéÆ Input ÂèÇÊï∞</h2>
                <div class="param-grid" id="inputPanel"></div>
            </div>

            <!-- Output ÂèÇÊï∞Èù¢Êùø -->
            <div class="panel panel-output">
                <h2>üìä Output ÂèÇÊï∞</h2>
                <div class="param-grid" id="outputPanel"></div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        const parameters = {};
        let ws = null;

        // ===== WebSocketËøûÊé• =====
        function connect() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            console.log('[WebSocket] Connecting to:', wsUrl);
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('[WebSocket] Connected successfully');
                document.getElementById('statusDot').classList.add('connected');
                document.getElementById('statusText').textContent = 'Â∑≤ËøûÊé•';
            };

            ws.onclose = (event) => {
                console.log('[WebSocket] Closed:', event.code, event.reason);
                document.getElementById('statusDot').classList.remove('connected');
                document.getElementById('statusText').textContent = 'Â∑≤Êñ≠ÂºÄÔºåÈáçËøû‰∏≠...';
                setTimeout(connect, 2000);
            };

            ws.onerror = (err) => {
                console.error('[WebSocket] Error:', err);
            };

            ws.onmessage = (event) => {
                try {
                    const msg = JSON.parse(event.data);
                    handleMessage(msg);
                } catch (e) {
                    console.error('[WebSocket] Invalid message:', e);
                }
            };
        }

        // ===== Ê∂àÊÅØÂ§ÑÁêÜ =====
        function handleMessage(msg) {
            switch(msg.type) {
                case 'init':
                    console.log('[WebSocket] Received init with', msg.parameters.length, 'parameters');
                    console.log('[WebSocket] First param:', msg.parameters[0]);
                    msg.parameters.forEach(p => {
                        parameters[p.name] = p;
                    });
                    renderUI();
                    break;

                case 'output':
                    if (parameters[msg.name]) {
                        parameters[msg.name].value = msg.value;
                        updateOutputDisplay(msg.name, msg.value);
                    }
                    break;

                case 'input':
                    if (parameters[msg.name]) {
                        parameters[msg.name].value = msg.value;
                        updateInputDisplay(msg.name, msg.value);
                    }
                    break;
            }
        }

        // ===== Ê∏≤ÊüìUI =====
        function renderUI() {
            const inputPanel = document.getElementById('inputPanel');
            const outputPanel = document.getElementById('outputPanel');

            inputPanel.innerHTML = '';
            outputPanel.innerHTML = '';

            console.log('[Render] Total parameters:', Object.keys(parameters).length);

            let inputCount = 0;
            let outputCount = 0;

            Object.values(parameters).forEach(param => {
                // ÊèêÂèñÂèÇÊï∞Á±ªÂà´ÂâçÁºÄ
                const categoryPrefix = param.name.split('_')[0];

                if (param.isInput) {
                    const el = createInputControl(param, categoryPrefix);
                    inputPanel.appendChild(el);
                    inputCount++;
                }

                if (param.isOutput) {
                    const el = createOutputDisplay(param, categoryPrefix);
                    outputPanel.appendChild(el);
                    outputCount++;
                }
            });

            console.log(`[Render] Input: ${inputCount}, Output: ${outputCount}`);
        }

        // ===== ÂàõÂª∫InputÊéß‰ª∂ =====
        function createInputControl(param, category) {
            const div = document.createElement('div');
            div.className = 'param-item';
            div.dataset.name = param.name;

            let controlHTML = '';

            if (param.type === 'Bool') {
                const checked = param.value ? 'checked' : '';
                controlHTML = `
                    <span class="param-name">${param.displayName || param.name}</span>
                    <span class="param-type">${param.type}</span>
                    <label class="switch">
                        <input type="checkbox" ${checked} onchange="sendParamValue('${param.name}', this.checked)">
                        <span class="slider-switch"></span>
                    </label>
                    <span class="param-category">${category}</span>
                `;
            } else if (param.type === 'String') {
                // String Á±ªÂûãÊòæÁ§∫‰∏∫ÊñáÊú¨ËæìÂÖ•
                const value = param.value || '';
                controlHTML = `
                    <span class="param-name">${param.displayName || param.name}</span>
                    <span class="param-type">${param.type}</span>
                    <input type="text" value="${value}" style="flex:1; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.1); color:#fff; padding:5px 10px; border-radius:4px;"
                           onchange="sendParamValue('${param.name}', this.value)">
                    <span class="param-category">${category}</span>
                `;
            } else {
                // Int/Float ‰ΩøÁî®ÊªëÂùó
                const min = param.min !== undefined ? param.min : 0;
                const max = param.max !== undefined ? param.max : (param.type === 'Int' ? 255 : 1);
                const step = param.type === 'Int' ? 1 : 0.01;
                const value = param.value !== null ? param.value : min;

                controlHTML = `
                    <span class="param-name">${param.displayName || param.name}</span>
                    <span class="param-type">${param.type}</span>
                    <div class="slider-container">
                        <input type="range" min="${min}" max="${max}" step="${step}"
                               value="${value}"
                               oninput="handleSliderChange('${param.name}', this.value, '${param.type}')">
                        <span class="value-display" id="val-${param.name}">${Number(value).toFixed(param.type === 'Int' ? 0 : 2)}</span>
                    </div>
                    <span class="param-category">${category}</span>
                `;
            }

            div.innerHTML = controlHTML;
            return div;
        }

        // ===== ÂàõÂª∫OutputÊòæÁ§∫ =====
        function createOutputDisplay(param, category) {
            const div = document.createElement('div');
            div.className = 'param-item';
            div.dataset.name = param.name;

            let displayHTML = '';

            if (param.type === 'Bool') {
                const active = param.value ? 'active' : '';
                const status = param.value ? 'ON' : 'OFF';
                displayHTML = `
                    <span class="param-name">${param.displayName || param.name}</span>
                    <span class="param-type">${param.type}</span>
                    <div class="bool-indicator ${active}" id="out-${param.name}"></div>
                    <span class="output-value" id="val-out-${param.name}">${status}</span>
                    <span class="param-category">${category}</span>
                `;
            } else if (param.type === 'String') {
                const value = param.value || '-';
                displayHTML = `
                    <span class="param-name">${param.displayName || param.name}</span>
                    <span class="param-type">${param.type}</span>
                    <span class="output-value" id="val-out-${param.name}" style="flex:1; text-align:left; margin-left:10px; overflow:hidden; text-overflow:ellipsis;">${value}</span>
                    <span class="param-category">${category}</span>
                `;
            } else {
                // Int/Float ‰ΩøÁî®ËøõÂ∫¶Êù°
                const value = param.value !== null ? param.value : 0;
                const min = param.min !== undefined ? param.min : 0;
                const max = param.max !== undefined ? param.max : 1;
                const percent = max !== min ? ((value - min) / (max - min) * 100) : 0;
                const displayValue = param.type === 'Int' ? value : value.toFixed(3);

                displayHTML = `
                    <span class="param-name">${param.displayName || param.name}</span>
                    <span class="param-type">${param.type}</span>
                    <div class="progress-bar">
                        <div class="progress-fill" id="bar-${param.name}" style="width: ${Math.max(0, Math.min(100, percent))}%"></div>
                    </div>
                    <span class="output-value" id="val-out-${param.name}">${displayValue}</span>
                    <span class="param-category">${category}</span>
                `;
            }

            div.innerHTML = displayHTML;
            return div;
        }

        // ===== ÊªëÂùóÂ§ÑÁêÜ =====
        function handleSliderChange(name, value, type) {
            const display = document.getElementById(`val-${name}`);
            if (display) {
                display.textContent = type === 'Int' ? parseInt(value) : parseFloat(value).toFixed(2);
            }
            sendParamValue(name, type === 'Int' ? parseInt(value) : parseFloat(value));
        }

        // ===== ÂèëÈÄÅÂèÇÊï∞ÂÄº =====
        function sendParamValue(name, value) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;

            ws.send(JSON.stringify({
                type: 'set',
                name: name,
                value: value
            }));
        }

        // ===== Êõ¥Êñ∞OutputÊòæÁ§∫ =====
        function updateOutputDisplay(name, value) {
            const param = parameters[name];
            if (!param) return;

            if (param.type === 'Bool') {
                const indicator = document.getElementById(`out-${name}`);
                const valDisplay = document.getElementById(`val-out-${name}`);
                if (indicator) {
                    if (value === 1 || value === true) {
                        indicator.classList.add('active');
                    } else {
                        indicator.classList.remove('active');
                    }
                }
                if (valDisplay) valDisplay.textContent = (value === 1 || value === true) ? 'ON' : 'OFF';
            } else if (param.type === 'String') {
                const valDisplay = document.getElementById(`val-out-${name}`);
                if (valDisplay) valDisplay.textContent = value || '-';
            } else {
                const bar = document.getElementById(`bar-${name}`);
                const valDisplay = document.getElementById(`val-out-${name}`);

                const min = param.min !== undefined ? param.min : 0;
                const max = param.max !== undefined ? param.max : 1;
                const percent = max !== min ? ((value - min) / (max - min) * 100) : 0;

                if (valDisplay) {
                    valDisplay.textContent = param.type === 'Int' ? value : value.toFixed(3);
                }
                if (bar) {
                    bar.style.width = `${Math.max(0, Math.min(100, percent))}%`;
                }
            }
        }

        // ===== Êõ¥Êñ∞InputÊòæÁ§∫ =====
        function updateInputDisplay(name, value) {
            const param = parameters[name];
            if (!param) return;

            const item = document.querySelector(`.param-item[data-name="${name}"]`);
            if (!item) return;

            if (param.type === 'Bool') {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = value === 1 || value === true;
            } else if (param.type !== 'String') {
                const slider = item.querySelector('input[type="range"]');
                const display = document.getElementById(`val-${name}`);
                if (slider) slider.value = value;
                if (display) {
                    display.textContent = param.type === 'Int' ? parseInt(value) : parseFloat(value).toFixed(2);
                }
            }
        }

        // ===== ÂàùÂßãÂåñ =====
        connect();
    </script>
</body>
</html>
